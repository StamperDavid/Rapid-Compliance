
> ai-crm-platform@0.1.0 test
> jest

node.exe : PASS tests/auth-middleware.test.ts
At line:1 char:1
+ & "C:\Program Files\nodejs/node.exe" "C:\Program Files\nodejs/node_mo ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (PASS tests/auth-middleware.test.ts:String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

PASS tests/validation.test.ts
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

PASS tests/website-multi-tenant.test.ts
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

PASS tests/rate-limiting.test.ts
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

PASS tests/integration/api-routes.test.ts
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

PASS tests/api-routes.test.ts
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

PASS tests/integration/email-integration.test.ts
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

PASS tests/integration/sms-integration.test.ts
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

PASS tests/payment-service.test.ts
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

PASS tests/schema-adaptability.test.ts
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

PASS tests/oauth-service.test.ts
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

PASS tests/integration/payment-integration.test.ts
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

    console.log
      ΓÅ¡∩╕Å  Skipping Stripe test - Stripe API key not configured

      at Object.log (tests/integration/payment-integration.test.ts:82:17)

FAIL tests/services/workflow-service.test.ts (5.772 s)
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

  ΓùÅ WorkflowService ΓÇ║ getWorkflows with filters ΓÇ║ should filter workflows by status

    Failed to retrieve workflows: 9 FAILED_PRECONDITION: The query requires an index. You can create it here: https://c
onsole.firebase.google.com/v1/r/project/ai-sales-platform-dev/firestore/indexes?create_composite=Cldwcm9qZWN0cy9haS1zYW
xlcy1wbGF0Zm9ybS1kZXYvZGF0YWJhc2VzLyhkZWZhdWx0KS9jb2xsZWN0aW9uR3JvdXBzL3dvcmtmbG93cy9pbmRleGVzL18QARoKCgZzdGF0dXMQARoNC
gljcmVhdGVkQXQQAhoMCghfX25hbWVfXxAC

      65 |   } catch (error: any) {
      66 |     logger.error('Failed to get workflows', error, { organizationId, filters });
    > 67 |     throw new Error(`Failed to retrieve workflows: ${error.message}`);
         |           ^
      68 |   }
      69 | }
      70 |

      at getWorkflows (src/lib/workflows/workflow-service.ts:67:11)
      at Object.<anonymous> (tests/services/workflow-service.test.ts:163:22)

FAIL tests/integration/ui-pages.test.ts (5.907 s)
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

  ΓùÅ E-Commerce UI Integration ΓÇ║ should add product to cart (product detail ΓåÆ cart service)

    E-commerce not configured for this workspace

      316 |   
      317 |   if (!ecommerceConfig) {
    > 318 |     throw new Error('E-commerce not configured for this workspace');
          |           ^
      319 |   }
      320 |   
      321 |   const productSchema = (ecommerceConfig as any).productSchema;

      at getProduct (src/lib/ecommerce/cart-service.ts:318:11)
      at addToCart (src/lib/ecommerce/cart-service.ts:97:19)
      at Object.<anonymous> (tests/integration/ui-pages.test.ts:28:18)

  ΓùÅ E-Commerce UI Integration ΓÇ║ should process checkout (checkout page ΓåÆ checkout service)

    E-commerce not configured for this workspace

      316 |   
      317 |   if (!ecommerceConfig) {
    > 318 |     throw new Error('E-commerce not configured for this workspace');
          |           ^
      319 |   }
      320 |   
      321 |   const productSchema = (ecommerceConfig as any).productSchema;

      at getProduct (src/lib/ecommerce/cart-service.ts:318:11)
      at addToCart (src/lib/ecommerce/cart-service.ts:97:19)
      at Object.<anonymous> (tests/integration/ui-pages.test.ts:36:5)

  ΓùÅ Workflow UI Integration ΓÇ║ should execute workflow (workflow page ΓåÆ workflow engine)

    expect(received).toBe(expected) // Object.is equality

    Expected: "completed"
    Received: "failed"

      125 |     
      126 |     expect(execution).toBeDefined();
    > 127 |     expect(execution.status).toBe('completed');
          |                              ^
      128 |   }, 15000);
      129 | });
      130 |

      at Object.toBe (tests/integration/ui-pages.test.ts:127:30)

  ΓùÅ Email Campaign UI Integration ΓÇ║ should create campaign (campaign builder ΓåÆ campaign service)

    FirebaseError: Function setDoc() called with invalid data. Unsupported field value: undefined (found in field 
workspaceId in document organizations/test-org-1766953568732/emailCampaigns/campaign_1766953570373_w0l4ecsow)


FAIL tests/pagination-validation.test.ts (7.324 s)
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

    console.log
      Setting up test data for pagination validation...

      at Object.log (tests/pagination-validation.test.ts:23:13)

    console.log
      Creating 2000 test leads...

      at Object.log (tests/pagination-validation.test.ts:38:13)

    console.log
        Created 0 leads...

      at Object.log (tests/pagination-validation.test.ts:56:17)

    console.log
      Cleaning up test data...

      at Object.log (tests/pagination-validation.test.ts:88:13)

    console.log
      Cleanup complete (test org can be manually removed)

      at Object.log (tests/pagination-validation.test.ts:93:13)

  ΓùÅ Pagination Stress Testing ΓÇ║ should paginate leads without crashing (2000 records)

    thrown: "Exceeded timeout of 5000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See 
https://jestjs.io/docs/api#testname-fn-timeout."

      20 |   };
      21 |
    > 22 |   beforeAll(async () => {
         |            ^
      23 |     console.log('Setting up test data for pagination validation...');
      24 |     
      25 |     // Create test organization

      at tests/pagination-validation.test.ts:22:12
      at Object.<anonymous> (tests/pagination-validation.test.ts:12:9)

  ΓùÅ Pagination Stress Testing ΓÇ║ should paginate deals without timeout (1000 records)

    thrown: "Exceeded timeout of 5000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See 
https://jestjs.io/docs/api#testname-fn-timeout."

      20 |   };
      21 |
    > 22 |   beforeAll(async () => {
         |            ^
      23 |     console.log('Setting up test data for pagination validation...');
      24 |     
      25 |     // Create test organization

      at tests/pagination-validation.test.ts:22:12
      at Object.<anonymous> (tests/pagination-validation.test.ts:12:9)

  ΓùÅ Pagination Stress Testing ΓÇ║ should handle empty collections gracefully

    thrown: "Exceeded timeout of 5000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See 
https://jestjs.io/docs/api#testname-fn-timeout."

      20 |   };
      21 |
    > 22 |   beforeAll(async () => {
         |            ^
      23 |     console.log('Setting up test data for pagination validation...');
      24 |     
      25 |     // Create test organization

      at tests/pagination-validation.test.ts:22:12
      at Object.<anonymous> (tests/pagination-validation.test.ts:12:9)

  ΓùÅ Pagination Stress Testing ΓÇ║ should iterate through all pages correctly

    thrown: "Exceeded timeout of 5000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See 
https://jestjs.io/docs/api#testname-fn-timeout."

      20 |   };
      21 |
    > 22 |   beforeAll(async () => {
         |            ^
      23 |     console.log('Setting up test data for pagination validation...');
      24 |     
      25 |     // Create test organization

      at tests/pagination-validation.test.ts:22:12
      at Object.<anonymous> (tests/pagination-validation.test.ts:12:9)


ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From 
tests/pagination-validation.test.ts.

      at Firestore.createCallOptions (node_modules/@google-cloud/firestore/build/src/index.js:1233:22)
      at Firestore.request (node_modules/@google-cloud/firestore/build/src/index.js:1373:34)
      at WriteBatch._commit (node_modules/@google-cloud/firestore/build/src/write-batch.js:480:32)
PASS tests/services/product-service.test.ts (7.805 s)
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

FAIL tests/services/deal-service.test.ts (11.592 s)
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

  ΓùÅ DealService ΓÇ║ getDeals with pagination ΓÇ║ should filter deals by stage

    Failed to retrieve deals: 9 FAILED_PRECONDITION: The query requires an index. You can create it here: https://conso
le.firebase.google.com/v1/r/project/ai-sales-platform-dev/firestore/indexes?create_composite=ClVwcm9qZWN0cy9haS1zYWxlcy
1wbGF0Zm9ybS1kZXYvZGF0YWJhc2VzLyhkZWZhdWx0KS9jb2xsZWN0aW9uR3JvdXBzL3JlY29yZHMvaW5kZXhlcy9fEAEaCQoFc3RhZ2UQARoNCgljcmVhd
GVkQXQQAhoMCghfX25hbWVfXxAC

      91 |   } catch (error: any) {
      92 |     logger.error('Failed to get deals', error, { organizationId, filters });
    > 93 |     throw new Error(`Failed to retrieve deals: ${error.message}`);
         |           ^
      94 |   }
      95 | }
      96 |

      at getDeals (src/lib/crm/deal-service.ts:93:11)
      at Object.<anonymous> (tests/services/deal-service.test.ts:150:22)

FAIL tests/services/lead-service.test.ts (15.422 s)
  ΓùÅ Console

    console.log
      [Jest Setup] Firebase Admin Config: {
        projectId: 'ai-sales-platform-dev',
        clientEmail: 'SET',
        privateKeyLength: 1704
      }

      at Object.log (jest.setup.js:72:9)

  ΓùÅ LeadService ΓÇ║ createLead ΓÇ║ should create a new lead with all required fields

    expect(received).toBe(expected) // Object.is equality

    Expected: 50
    Received: 55

      63 |       expect(lead.organizationId).toBe(testOrgId);
      64 |       expect(lead.workspaceId).toBe(testWorkspaceId);
    > 65 |       expect(lead.score).toBe(50); // Default score
         |                          ^
      66 |       expect(lead.createdAt).toBeDefined();
      67 |     });
      68 |

      at Object.toBe (tests/services/lead-service.test.ts:65:26)

  ΓùÅ LeadService ΓÇ║ getLeads with pagination ΓÇ║ should filter leads by status

    Failed to retrieve leads: 9 FAILED_PRECONDITION: The query requires an index. You can create it here: https://conso
le.firebase.google.com/v1/r/project/ai-sales-platform-dev/firestore/indexes?create_composite=ClVwcm9qZWN0cy9haS1zYWxlcy
1wbGF0Zm9ybS1kZXYvZGF0YWJhc2VzLyhkZWZhdWx0KS9jb2xsZWN0aW9uR3JvdXBzL3JlY29yZHMvaW5kZXhlcy9fEAEaCgoGc3RhdHVzEAEaDQoJY3JlY
XRlZEF0EAIaDAoIX19uYW1lX18QAg

       98 |   } catch (error: any) {
       99 |     logger.error('Failed to get leads', error, { organizationId, workspaceId, filters });
    > 100 |     throw new Error(`Failed to retrieve leads: ${error.message}`);
          |           ^
      101 |   }
      102 | }
      103 |

      at getLeads (src/lib/crm/lead-service.ts:100:11)
      at Object.<anonymous> (tests/services/lead-service.test.ts:187:22)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due 
to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure 
that .unref() was called on them.
Test Suites: 5 failed, 13 passed, 18 total
Tests:       12 failed, 4 skipped, 143 passed, 159 total
Snapshots:   0 total
Time:        16.664 s, estimated 17 s
Ran all test suites.
