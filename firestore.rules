rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // HELPER FUNCTIONS - BINARY RBAC
    // ========================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is an admin (binary role check)
    function isAdmin() {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ========================================
    // USERS COLLECTION
    // ========================================

    match /users/{userId} {
      // CRITICAL: Users can ALWAYS read their own profile (prevents circular dependency)
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // Users can update their own profile (except role field)
      allow update: if isAuthenticated()
        && request.auth.uid == userId
        && !('role' in request.resource.data.diff(resource.data).affectedKeys());

      // Admins have full access to all users
      allow read, write: if isAdmin();

      // Admins can create/delete users
      allow create, delete: if isAdmin();
    }

    // ========================================
    // ORGANIZATIONS COLLECTION
    // ========================================

    match /organizations/{orgId} {
      // All authenticated users can read organization config
      allow read: if isAuthenticated();

      // Only admins can write organization config
      allow write: if isAdmin();
    }

    // ========================================
    // TOP-LEVEL COLLECTIONS
    // ========================================

    // Schemas collection
    match /schemas/{schemaId} {
      // All authenticated users can read schemas
      allow read: if isAuthenticated();

      // All authenticated users can create/update schemas
      allow create, update: if isAuthenticated();

      // Only admins can delete schemas
      allow delete: if isAdmin();
    }

    // Records collection (entity records)
    match /records/{recordId} {
      // All authenticated users can read records
      allow read: if isAuthenticated();

      // All authenticated users can create/update records
      allow create, update: if isAuthenticated();

      // Only admins can delete records
      allow delete: if isAdmin();
    }

    // Workflows collection
    match /workflows/{workflowId} {
      // All authenticated users can read workflows
      allow read: if isAuthenticated();

      // All authenticated users can create/update workflows
      allow create, update: if isAuthenticated();

      // Only admins can delete workflows
      allow delete: if isAdmin();
    }

    // Email campaigns collection
    match /emailCampaigns/{campaignId} {
      // All authenticated users can read campaigns
      allow read: if isAuthenticated();

      // All authenticated users can create/update campaigns
      allow create, update: if isAuthenticated();

      // Only admins can delete campaigns
      allow delete: if isAdmin();
    }

    // Nurture sequences collection
    match /nurtureSequences/{sequenceId} {
      // All authenticated users can read sequences
      allow read: if isAuthenticated();

      // All authenticated users can create/update sequences
      allow create, update: if isAuthenticated();

      // Only admins can delete sequences
      allow delete: if isAdmin();
    }

    // API keys collection
    match /apiKeys/{keyId} {
      // Only admins can read/manage API keys
      allow read, write: if isAdmin();
    }

    // Admin collections
    match /admin/{document=**} {
      // Only admins have full access
      allow read, write: if isAdmin();
    }

    // System collections
    match /system/{collection}/{document=**} {
      // Public read for system data
      allow read: if true;

      // Only admins can write
      allow write: if isAdmin();
    }

    // Platform collections
    match /platform/{collection}/{document=**} {
      // Public read for platform config
      allow read: if true;

      // Only admins can write
      allow write: if isAdmin();
    }

    // Base Models collection (training models)
    match /baseModels/{modelId} {
      // All authenticated users can read base models
      allow read: if isAuthenticated();

      // All authenticated users can create/update
      allow create, update: if isAuthenticated();

      // Only admins can delete
      allow delete: if isAdmin();
    }

    // Golden Masters collection (AI agent configs)
    match /goldenMasters/{masterId} {
      // All authenticated users can read Golden Masters
      allow read: if isAuthenticated();

      // All authenticated users can create/update
      allow create, update: if isAuthenticated();

      // Only admins can delete
      allow delete: if isAdmin();
    }

    // Customer Memories collection (AI agent memories)
    match /customerMemories/{memoryId} {
      // All authenticated users can read memories
      allow read: if isAuthenticated();

      // All authenticated users can create/update (for AI agent use)
      allow create, update: if isAuthenticated();

      // Only admins can delete
      allow delete: if isAdmin();
    }

    // Themes collection
    match /themes/{themeId} {
      // All authenticated users can read themes
      allow read: if isAuthenticated();

      // All authenticated users can create/update
      allow create, update: if isAuthenticated();

      // Only admins can delete
      allow delete: if isAdmin();
    }

    // Integrations collection
    match /integrations/{integrationId} {
      // All authenticated users can read integrations
      allow read: if isAuthenticated();

      // All authenticated users can create/update
      allow create, update: if isAuthenticated();

      // Only admins can delete
      allow delete: if isAdmin();
    }

    // ========================================
    // ORGANIZATION SUBCOLLECTIONS
    // ========================================

    // OAuth states (temporary OAuth flow data)
    match /organizations/{orgId}/oauthStates/{stateId} {
      allow read, write: if isAuthenticated();
    }

    // Enrichment costs (billing data)
    match /organizations/{orgId}/enrichment-costs/{costId} {
      // All authenticated users can read enrichment costs
      allow read: if isAuthenticated();

      // Admins can create/update
      allow create, update: if isAdmin();
    }

    // Enrichment cache (read-only for users, system writes)
    match /organizations/{orgId}/enrichment-cache/{cacheId} {
      // All authenticated users can read cache
      allow read: if isAuthenticated();

      // Only admins can write (backend via admin SDK)
      allow write: if isAdmin();
    }

    // Integration status (OAuth token metadata)
    match /organizations/{orgId}/integrationStatus/{statusId} {
      // All authenticated users can read/write integration status
      allow read, write: if isAuthenticated();
    }

    // A/B Tests
    match /organizations/{orgId}/abTests/{testId} {
      // All authenticated users can read tests
      allow read: if isAuthenticated();

      // Admins can create/update/delete
      allow create, update, delete: if isAdmin();
    }

    // Agent persona & knowledge base
    match /organizations/{orgId}/agentPersona/{docId} {
      // All authenticated users can read
      allow read: if isAuthenticated();

      // Admins can create/update/delete
      allow create, update, delete: if isAdmin();
    }

    match /organizations/{orgId}/knowledgeBase/{docId} {
      // All authenticated users can read
      allow read: if isAuthenticated();

      // Admins can create/update/delete
      allow create, update, delete: if isAdmin();
    }

    // Active/archived agent instances (system managed)
    match /organizations/{orgId}/activeInstances/{instanceId} {
      // All authenticated users can read instances
      allow read: if isAuthenticated();

      // Only admins can write
      allow write: if isAdmin();
    }

    match /organizations/{orgId}/archivedInstances/{instanceId} {
      // All authenticated users can read instances
      allow read: if isAuthenticated();

      // Only admins can write
      allow write: if isAdmin();
    }

    // Email sync data
    match /organizations/{orgId}/emails/{emailId} {
      allow read, write: if isAuthenticated();
    }

    // SMS messages
    match /organizations/{orgId}/smsMessages/{messageId} {
      allow read, write: if isAuthenticated();
    }

    // SMS templates
    match /organizations/{orgId}/smsTemplates/{templateId} {
      // All authenticated users can read templates
      allow read: if isAuthenticated();

      // Admins can create/update/delete
      allow create, update, delete: if isAdmin();
    }

    // Sequences & enrollments
    match /organizations/{orgId}/sequences/{sequenceId} {
      allow read, write: if isAuthenticated();
    }

    match /organizations/{orgId}/enrollments/{enrollmentId} {
      allow read, write: if isAuthenticated();
    }

    match /organizations/{orgId}/sequenceAnalytics/{analyticsId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /organizations/{orgId}/sequenceStepStats/{statsId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Schema change events (system-managed)
    match /organizations/{orgId}/schemaChangeEvents/{eventId} {
      // All authenticated users can read events
      allow read: if isAuthenticated();

      // Only admins can write (system via admin SDK)
      allow write: if isAdmin();
    }

    // Schema issues dashboard
    match /organizations/{orgId}/schemaIssues/{issueId} {
      // All authenticated users can read issues
      allow read: if isAuthenticated();

      // All authenticated users can update (mark as resolved)
      allow update: if isAuthenticated();

      // Only admins can create/delete (system via admin SDK)
      allow create, delete: if isAdmin();
    }

    // Notifications
    match /organizations/{orgId}/notifications/{notificationId} {
      // All authenticated users can read/update notifications
      allow read, update: if isAuthenticated();

      // Only admins can create/delete (system via admin SDK)
      allow create, delete: if isAdmin();
    }

    // Integration field mappings
    match /organizations/{orgId}/integrationFieldMappings/{mappingId} {
      // All authenticated users can read mappings
      allow read: if isAuthenticated();

      // Admins can create/update/delete
      allow create, update, delete: if isAdmin();
    }

    // ========================================
    // WEBSITE BUILDER
    // ========================================

    // Website configuration
    match /organizations/{orgId}/website/settings {
      // All authenticated users can read settings
      allow read: if isAuthenticated();

      // Admins can create/update
      allow create, update: if isAdmin();

      // Never delete site config
      allow delete: if false;
    }

    // Website pages
    match /organizations/{orgId}/website/pages/{pageId} {
      // Published pages can be read publicly
      allow read: if resource.data.status == 'published';

      // Authenticated users can read all pages (including drafts)
      allow read: if isAuthenticated();

      // Admins can create/update/delete pages
      allow create, update, delete: if isAdmin();
    }

    // Blog posts
    match /organizations/{orgId}/website/posts/{postId} {
      // Published posts can be read publicly
      allow read: if resource.data.status == 'published';

      // Authenticated users can read all posts
      allow read: if isAuthenticated();

      // Admins can create/update/delete
      allow create, update, delete: if isAdmin();
    }

    // Website theme
    match /organizations/{orgId}/website/theme {
      // All authenticated users can read theme
      allow read: if isAuthenticated();

      // Admins can create/update
      allow create, update: if isAdmin();

      // Never delete theme
      allow delete: if false;
    }

    // Navigation
    match /organizations/{orgId}/website/navigation {
      // All authenticated users can read navigation
      allow read: if isAuthenticated();

      // Admins can create/update
      allow create, update: if isAdmin();

      // Never delete navigation
      allow delete: if false;
    }

    // Custom templates
    match /organizations/{orgId}/website/templates/{templateId} {
      // All authenticated users can read templates
      allow read: if isAuthenticated();

      // Admins can create/update/delete
      allow create, update, delete: if isAdmin();
    }

    // Website media/assets
    match /organizations/{orgId}/website/media/{mediaId} {
      // All authenticated users can read media
      allow read: if isAuthenticated();

      // All authenticated users can create media
      allow create: if isAuthenticated();

      // Admins can update/delete
      allow update, delete: if isAdmin();
    }

    // Preview tokens
    match /organizations/{orgId}/website/preview-tokens/tokens/{tokenId} {
      // Anyone can read with the token (for preview links)
      allow read: if true;

      // Admins can create/delete tokens
      allow create, delete: if isAdmin();
    }

    // Audit log entries
    match /organizations/{orgId}/website/audit-log/entries/{entryId} {
      // Admins can read audit log
      allow read: if isAdmin();

      // System creates entries (via Admin SDK)
      allow write: if isAdmin();
    }

    // Page version history
    match /organizations/{orgId}/website/pages/items/{pageId}/versions/{versionId} {
      // Admins can read versions
      allow read: if isAdmin();

      // System creates versions (via Admin SDK)
      allow write: if isAdmin();
    }

    // Blog posts in config subcollection
    match /organizations/{orgId}/website/config/blog-posts/{postId} {
      // Published posts can be read publicly
      allow read: if resource.data.status == 'published';

      // Authenticated users can read all posts
      allow read: if isAuthenticated();

      // Admins can create/update/delete
      allow create, update, delete: if isAdmin();
    }

    // Blog categories
    match /organizations/{orgId}/website/config/blog-categories/{categoryId} {
      // Anyone can read categories (for blog navigation)
      allow read: if true;

      // Admins can create/update/delete
      allow create, update, delete: if isAdmin();
    }

    // Custom domains in config subcollection
    match /organizations/{orgId}/website/config/custom-domains/{domainId} {
      // All authenticated users can read domains
      allow read: if isAuthenticated();

      // Admins can create/update/delete
      allow create, update, delete: if isAdmin();
    }

    // Pages in items subcollection
    match /organizations/{orgId}/website/pages/items/{pageId} {
      // Published pages can be read publicly
      allow read: if resource.data.status == 'published';

      // Authenticated users can read all pages
      allow read: if isAuthenticated();

      // Admins can create/update/delete
      allow create, update, delete: if isAdmin();
    }

    // ========================================
    // CUSTOM DOMAIN REGISTRY
    // ========================================

    // Custom domains - GLOBAL collection
    match /customDomains/{domain} {
      // Anyone can read domain status (for DNS verification UI)
      allow read: if true;

      // Admins can create/update/delete domains
      allow create, update, delete: if isAdmin();
    }

    // Subdomain registry - GLOBAL collection
    match /subdomains/{subdomain} {
      // Anyone can read (for subdomain availability check)
      allow read: if true;

      // Admins can create subdomains
      allow create: if isAdmin();

      // Cannot update or delete subdomains
      allow update, delete: if false;
    }

    // ========================================
    // GENERIC ORGANIZATION SUBCOLLECTIONS
    // ========================================

    // Generic subcollections (leads, deals, prospects, tasks, etc.)
    match /organizations/{orgId}/{subcollection}/{docId} {
      // All authenticated users can read
      allow read: if isAuthenticated();

      // All authenticated users can create/update
      allow create, update: if isAuthenticated();

      // Admins can delete
      allow delete: if isAdmin();
    }

    // Base Models subcollection (within organizations)
    match /organizations/{orgId}/baseModels/{modelId} {
      // All authenticated users can read
      allow read: if isAuthenticated();

      // Admins can write
      allow write: if isAdmin();
    }

    // Golden Masters subcollection (within organizations)
    match /organizations/{orgId}/goldenMasters/{masterId} {
      // All authenticated users can read
      allow read: if isAuthenticated();

      // Admins can write
      allow write: if isAdmin();
    }

    // ========================================
    // CHAT SESSIONS
    // ========================================

    // Chat sessions
    match /chatSessions/{sessionId} {
      // All authenticated users can read/write sessions
      allow read, write: if isAuthenticated();
    }

    // Chat messages within sessions
    match /chatSessions/{sessionId}/messages/{messageId} {
      // All authenticated users can read/write messages
      allow read, write: if isAuthenticated();
    }

    // ========================================
    // SUBSCRIPTIONS
    // ========================================

    // Subscription plans (read-only for users)
    match /subscriptionPlans/{planId} {
      // All authenticated users can read plans
      allow read: if isAuthenticated();

      // Only admins can write
      allow write: if isAdmin();
    }

    // Customer subscriptions
    match /customerSubscriptions/{subscriptionId} {
      // All authenticated users can read subscription
      allow read: if isAuthenticated();

      // Only admins can modify subscription
      allow write: if isAdmin();
    }

    // ========================================
    // DISCOVERY ARCHIVE
    // ========================================

    // Discovery Archive (auto-deleted after 30 days via TTL)
    match /discoveryArchive/{scrapeId} {
      // All authenticated users can read/write scrapes
      allow read, write: if isAuthenticated();
    }

    // ========================================
    // DEFAULT DENY
    // ========================================

    // Default: Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
